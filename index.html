<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kalkulator Patungan + OCR Struk</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
    }
    h2, h3 {
      text-align: center;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      font-size: 14px;
    }
    input {
      width: 100%;
    }
    .person {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .person input {
      flex: 1;
    }
    .person input.jumlah-orang {
      flex: 0.3;
    }
    #result {
      background: #eee;
      padding: 10px;
      margin-top: 20px;
    }
    #waShare {
      display: inline-block;
      background: #25D366;
      color: white;
      padding: 8px 16px;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Kalkulator Patungan</h2>
    <input type="file" id="upload" accept="image/*">
    <div id="items"></div>

    <h3>Orang yang Patungan</h3>
    <div id="people">
      <div class="person">
        <input type="text" placeholder="Nama" class="nama">
        <input type="number" placeholder="Jumlah item" class="jumlah-orang" value="1">
        <button onclick="hapusOrang(this)">Hapus</button>
      </div>
    </div>
    <button onclick="tambahOrang()">+ Tambah Orang</button>
    <hr>
    <button onclick="hitungPatungan()">Hitung Patungan</button>
    <button onclick="location.reload()">ðŸ”„ Reset</button>
    <div id="result"></div>
    <div id="share"></div>
  </div>
  <script>
    const itemsContainer = document.getElementById("items");
    const resultContainer = document.getElementById("result");
    const shareContainer = document.getElementById("share");

    document.getElementById("upload").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      Tesseract.recognize(file, 'eng').then(({ data: { text } }) => {
        const lines = text.split("\n").filter(l => l.trim());
        itemsContainer.innerHTML = "";
        for (let line of lines) {
          const match = line.match(/(.+?)\s+(\d{1,3}(?:\.\d{3})*|\d+)/);
          if (match) {
            const namaItem = match[1].replace(/\b\d+\s*[xX]\b/g, '').trim();
            const harga = match[2].replace(/\./g, "").replace(",", ".");
            itemsContainer.innerHTML += `
              <div class="person">
                <input type="text" value="${namaItem}">
                <input type="number" placeholder="Harga" value="${harga}">
              </div>
            `;
          }
        }
      });
    });

    function tambahOrang() {
      const div = document.createElement("div");
      div.className = "person";
      div.innerHTML = `
        <input type="text" placeholder="Nama" class="nama">
        <input type="number" placeholder="Jumlah item" class="jumlah-orang" value="1">
        <button onclick="hapusOrang(this)">Hapus</button>
      `;
      document.getElementById("people").appendChild(div);
    }

    function hapusOrang(btn) {
      btn.parentElement.remove();
    }

    function hitungPatungan() {
      const orangInputs = document.querySelectorAll("#people .person");
      const items = document.querySelectorAll("#items .person");
      let hargaTotal = 0;
      let hargaPerItem = [];

      items.forEach(item => {
        const harga = parseFloat(item.children[1].value);
        hargaTotal += harga;
        hargaPerItem.push(harga);
      });

      let totalOrang = 0;
      let distribusi = [];

      orangInputs.forEach(orang => {
        const nama = orang.querySelector(".nama").value || "Anonim";
        const jml = parseInt(orang.querySelector(".jumlah-orang").value);
        totalOrang += jml;
        distribusi.push({ nama, jml });
      });

      let result = `<h3>Total: Rp${hargaTotal.toLocaleString("id-ID")}</h3><ul>`;
      distribusi.forEach(o => {
        const proporsi = o.jml / totalOrang;
        const bayar = Math.round(hargaTotal * proporsi);
        result += `<li>${o.nama} bayar Rp${bayar.toLocaleString("id-ID")}</li>`;
      });
      result += "</ul>";
      resultContainer.innerHTML = result;

      const waText = encodeURIComponent(result.replace(/<[^>]+>/g, ""));
      shareContainer.innerHTML = `<a id="waShare" href="https://wa.me/?text=${waText}" target="_blank">Share ke WhatsApp</a>`;
    }
  </script>
</body>
</html>
